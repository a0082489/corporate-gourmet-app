<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コーポレートグルメ Pro - 高機能地図連動グルメアプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .rating-star {
            cursor: pointer;
            transition: color 0.2s;
        }
        .rating-star:hover,
        .rating-star.active {
            color: #fbbf24;
        }
        .restaurant-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .restaurant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .store-info-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .store-info-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .store-info-card.selected {
            border: 2px solid #ef4444;
            background: #fef2f2;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
        }
        .map-popup {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .distance-badge {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .google-rating {
            background: linear-gradient(45deg, #34d399, #10b981);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .operating-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-open {
            background: #dcfce7;
            color: #166534;
        }
        .status-closed {
            background: #fee2e2;
            color: #991b1b;
        }
        .store-info-container {
            max-height: 300px;
            overflow-y: auto;
        }
         {
            .no-print { display: none !important; }
            body { font-size: 12px; }
            #map { height: 300px !important; }
            .store-info-container { max-height: 200px !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ヘッダー -->
    <header class="bg-red-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-utensils mr-3"></i>
                    コーポレートグルメ Pro
                </h1>
                <div id="userInfo" class="hidden">
                    <span id="welcomeMessage" class="mr-4"></span>
                    <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ログイン・登録フォーム -->
    <div id="authSection" class="container mx-auto px-4 py-8 max-w-md">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">会員登録・ログイン</h2>
            
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">会社名</label>
                    <input type="text" id="companyName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 株式会社サンプル">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ユーザーネーム</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 田中太郎">
                </div>
                
                <button onclick="login()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>ログイン
                </button>
                
                <p class="text-sm text-gray-600 text-center mt-4">
                    初回利用時は自動的にアカウントが作成されます
                </p>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="mainContent" class="hidden">
        <!-- 位置情報・地図セクション -->
        <div class="container mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-map-marked-alt mr-3 text-red-600"></i>
                        周辺のおすすめ店舗
                    </h3>
                    <button onclick="getCurrentLocation()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-location-arrow mr-2"></i>現在地を取得
                    </button>
                </div>
                
                <div id="locationStatus" class="mb-4 p-3 rounded-lg bg-gray-100 text-gray-600 hidden">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="locationText">位置情報を取得中...</span>
                </div>
                
                <div id="map" class="mb-4"></div>
                
                <div class="text-sm text-gray-600">
                    <i class="fas fa-lightbulb mr-2"></i>
                    地図上の店舗マーカーをクリックすると、その店舗の情報が投稿フォームに自動入力されます
                </div>
            </div>
        </div>

        <!-- 周辺店舗情報表示セクション -->
        <div id="storeInfoSection" class="container mx-auto px-4 py-6 hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-store mr-3 text-red-600"></i>
                    周辺店舗詳細情報
                    <span id="storeCount" class="ml-3 bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm"></span>
                </h3>
                
                <div id="storeInfoList" class="store-info-container space-y-4">
                    <!-- 店舗情報カードがここに表示されます -->
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    店舗カードをクリックして選択後、「この店舗を評価」ボタンで投稿フォームに情報が自動入力されます
                </div>
            </div>
        </div>

        <!-- 投稿フォーム -->
        <div class="container mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle mr-3 text-red-600"></i>
                    おすすめ店舗を投稿
                </h3>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">店舗名*</label>
                        <input type="text" id="restaurantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="店舗名を入力">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ジャンル</label>
                        <select id="genre" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">ジャンルを選択</option>
                            <option value="和食">和食</option>
                            <option value="洋食">洋食</option>
                            <option value="中華">中華</option>
                            <option value="イタリアン">イタリアン</option>
                            <option value="フレンチ">フレンチ</option>
                            <option value="居酒屋">居酒屋</option>
                            <option value="カフェ">カフェ</option>
                            <option value="ファストフード">ファストフード</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">エリア</label>
                        <input type="text" id="area" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 新宿、渋谷">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">評価</label>
                        <div class="flex items-center">
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="1"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="2"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="3"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="4"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="5"></i>
                            <span id="ratingText" class="ml-2 text-gray-600"></span>
                        </div>
                        <input type="hidden" id="rating" value="0">
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">店舗リンク（食べログ、ぐるなび等）</label>
                    <input type="url" id="restaurantLink" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="https://...">
                </div>
                
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">コメント</label>
                    <textarea id="comment" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="おすすめポイントや感想を記入してください"></textarea>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="addRestaurant()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-paper-plane mr-2"></i>投稿する
                    </button>
                </div>
            </div>
        </div>

        <!-- フィルター・検索 -->
        <div class="container mx-auto px-4 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-filter mr-3 text-red-600"></i>
                    検索・フィルター
                </h3>
                
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <input type="text" id="searchKeyword" placeholder="店舗名で検索" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                    </div>
                    
                    <div>
                        <select id="filterGenre" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">すべてのジャンル</option>
                            <option value="和食">和食</option>
                            <option value="洋食">洋食</option>
                            <option value="中華">中華</option>
                            <option value="イタリアン">イタリアン</option>
                            <option value="フレンチ">フレンチ</option>
                            <option value="居酒屋">居酒屋</option>
                            <option value="カフェ">カフェ</option>
                            <option value="ファストフード">ファストフード</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="filterRating" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">すべての評価</option>
                            <option value="5">★★★★★</option>
                            <option value="4">★★★★☆ 以上</option>
                            <option value="3">★★★☆☆ 以上</option>
                        </select>
                    </div>
                    
                    <div>
                        <button onclick="applyFilters()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 会社情報表示 -->
        <div class="container mx-auto px-4 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 id="companyTitle" class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-building mr-3 text-red-600"></i>
                </h3>
                <p class="text-gray-600 mt-2">同じ会社のメンバーが投稿したおすすめ店舗一覧</p>
            </div>
        </div>

        <!-- レストラン一覧 -->
        <div class="container mx-auto px-4 pb-8">
            <div id="restaurantList" class="grid gap-6">
                <!-- レストラン情報がここに表示されます -->
            </div>
            
            <div id="noResults" class="hidden text-center py-12">
                <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">該当する店舗が見つかりませんでした</p>
                <p class="text-gray-400 mt-2">検索条件を変更してお試しください</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
        let currentRating = 0;
        let map = null;
        let userLocation = null;
        let nearbyRestaurants = [];
        let selectedStoreId = null;

        // サンプル近隣店舗データ（Googleレビュー、営業状況を含む）
        const sampleNearbyRestaurants = [
            { 
                id: 'store1',
                name: "居酒屋 福福", 
                genre: "居酒屋", 
                lat: 35.6895, 
                lng: 139.6923, 
                distance: 150,
                googleRating: 4.2,
                isOpen: true,
                openHours: "17:00-24:00"
            },
            { 
                id: 'store2',
                name: "カフェ モーニング", 
                genre: "カフェ", 
                lat: 35.6885, 
                lng: 139.6913, 
                distance: 200,
                googleRating: 4.5,
                isOpen: true,
                openHours: "7:00-20:00"
            },
            { 
                id: 'store3',
                name: "中華料理 龍宮", 
                genre: "中華", 
                lat: 35.6905, 
                lng: 139.6933, 
                distance: 180,
                googleRating: 3.8,
                isOpen: false,
                openHours: "11:30-14:30, 17:30-22:00"
            },
            { 
                id: 'store4',
                name: "イタリアン ベラヴィスタ", 
                genre: "イタリアン", 
                lat: 35.6875, 
                lng: 139.6903, 
                distance: 250,
                googleRating: 4.7,
                isOpen: true,
                openHours: "11:00-22:00"
            },
            { 
                id: 'store5',
                name: "寿司処 まつ", 
                genre: "和食", 
                lat: 35.6915, 
                lng: 139.6943, 
                distance: 300,
                googleRating: 4.3,
                isOpen: false,
                openHours: "17:00-23:00"
            },
            { 
                id: 'store6',
                name: "ラーメン 一番", 
                genre: "その他", 
                lat: 35.6865, 
                lng: 139.6893, 
                distance: 320,
                googleRating: 4.0,
                isOpen: true,
                openHours: "11:00-15:00, 18:00-24:00"
            },
            { 
                id: 'store7',
                name: "フレンチ ル・ボンヴィヴァン", 
                genre: "フレンチ", 
                lat: 35.6925, 
                lng: 139.6953, 
                distance: 280,
                googleRating: 4.8,
                isOpen: false,
                openHours: "18:00-23:00"
            },
            { 
                id: 'store8',
                name: "焼肉 牛太郎", 
                genre: "その他", 
                lat: 35.6855, 
                lng: 139.6883, 
                distance: 400,
                googleRating: 4.1,
                isOpen: true,
                openHours: "17:00-2:00"
            }
        ];

        // 初期化
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainContent();
            }
            
            setupRatingSystem();
            displayRestaurants();
        };

        // 評価システムセットアップ
        function setupRatingSystem() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    setRating(rating);
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.querySelector('.flex.items-center').addEventListener('mouseleave', function() {
                highlightStars(currentRating);
            });
        }

        function setRating(rating) {
            currentRating = rating;
            document.getElementById('rating').value = rating;
            highlightStars(rating);
            
            const ratingText = ['', '★☆☆☆☆', '★★☆☆☆', '★★★☆☆', '★★★★☆', '★★★★★'][rating];
            document.getElementById('ratingText').textContent = ratingText;
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.remove('active');
                    star.classList.add('text-gray-300');
                }
            });
        }

        // 地図初期化
        function initMap() {
            // デフォルトの東京駅座標
            const defaultLat = 35.6812;
            const defaultLng = 139.7671;
            
            map = L.map('map').setView([defaultLat, defaultLng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 現在地取得を試行
            setTimeout(() => {
                getCurrentLocation();
            }, 500);
        }

        // 現在地取得
        function getCurrentLocation() {
            const locationStatus = document.getElementById('locationStatus');
            const locationText = document.getElementById('locationText');
            
            locationStatus.classList.remove('hidden');
            locationText.textContent = '位置情報を取得中...';
            
            if (!navigator.geolocation) {
                locationText.textContent = 'このブラウザでは位置情報がサポートされていません';
                locationStatus.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-600';
                showDefaultLocation();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    locationText.textContent = `現在地: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
                    locationStatus.className = 'mb-4 p-3 rounded-lg bg-green-100 text-green-600';
                    
                    // 地図を現在地に移動
                    map.setView([userLocation.lat, userLocation.lng], 16);
                    
                    // 現在地マーカー追加
                    L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('<div class="map-popup"><strong>現在地</strong></div>')
                        .openPopup();
                    
                    // 近隣店舗を表示
                    displayNearbyRestaurants();
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の取得が拒否されました';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が利用できません';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました';
                            break;
                        default:
                            errorMessage = '位置情報の取得に失敗しました';
                            break;
                    }
                    locationText.textContent = errorMessage;
                    locationStatus.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-600';
                    
                    showDefaultLocation();
                }
            );
        }

        // デフォルト位置表示
        function showDefaultLocation() {
            userLocation = { lat: 35.6895, lng: 139.6923 }; // 新宿駅周辺
            displayNearbyRestaurants();
        }

        // 近隣店舗表示
        function displayNearbyRestaurants() {
            if (!userLocation) return;
            
            // 現在地からの距離を計算
            nearbyRestaurants = sampleNearbyRestaurants.map(restaurant => {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    restaurant.lat, restaurant.lng
                );
                return { ...restaurant, distance: Math.round(distance) };
            }).sort((a, b) => a.distance - b.distance);

            // 地図にマーカーを追加
            nearbyRestaurants.forEach(restaurant => {
                const marker = L.marker([restaurant.lat, restaurant.lng])
                    .addTo(map);
                
                const popupContent = `
                    <div class="map-popup">
                        <h4 class="font-bold text-lg mb-2">${restaurant.name}</h4>
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-utensils mr-1"></i>${restaurant.genre}
                        </p>
                        <p class="text-sm text-blue-600 mb-3">
                            <i class="fas fa-walking mr-1"></i>徒歩約${Math.ceil(restaurant.distance / 80)}分 (${restaurant.distance}m)
                        </p>
                        <button onclick="selectRestaurantFromMap('${restaurant.name}', '${restaurant.genre}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i>この店舗を投稿
                        </button>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
            });

            // 店舗情報セクションを表示
            displayStoreInfoCards();
        }

        // 店舗情報カード表示
        function displayStoreInfoCards() {
            const storeInfoSection = document.getElementById('storeInfoSection');
            const storeInfoList = document.getElementById('storeInfoList');
            const storeCount = document.getElementById('storeCount');
            
            storeInfoSection.classList.remove('hidden');
            storeCount.textContent = `${nearbyRestaurants.length}件`;
            
            storeInfoList.innerHTML = nearbyRestaurants.map(store => `
                <div class="store-info-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md" 
                     id="store-${store.id}" onclick="selectStore('${store.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-gray-800 mb-1">${store.name}</h4>
                            <div class="flex items-center flex-wrap gap-2 mb-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                    ${store.genre}
                                </span>
                                <span class="google-rating">
                                    <i class="fas fa-star mr-1"></i>${store.googleRating}
                                </span>
                                <span class="distance-badge">
                                    ${store.distance}m
                                </span>
                                <span class="operating-status ${store.isOpen ? 'status-open' : 'status-closed'}">
                                    ${store.isOpen ? '営業中' : '営業時間外'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-clock mr-1"></i>
                            ${store.openHours}
                        </div>
                        <button onclick="selectStoreForRating('${store.id}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-star mr-1"></i>評価する
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 店舗選択
        function selectStore(storeId) {
            // 前の選択を解除
            if (selectedStoreId) {
                const prevCard = document.getElementById(`store-${selectedStoreId}`);
                if (prevCard) {
                    prevCard.classList.remove('selected');
                }
            }
            
            selectedStoreId = storeId;
            const card = document.getElementById(`store-${storeId}`);
            if (card) {
                card.classList.add('selected');
            }
        }

        // 店舗を評価用に選択
        function selectStoreForRating(storeId) {
            selectStore(storeId);
            const store = nearbyRestaurants.find(s => s.id === storeId);
            if (store) {
                selectRestaurantFromMap(store.name, store.genre);
            }
        }

        // 地図から店舗選択
        function selectRestaurantFromMap(name, genre) {
            document.getElementById('restaurantName').value = name;
            document.getElementById('genre').value = genre;
            
            // フォームまでスクロール
            document.getElementById('restaurantName').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // 入力フィールドをハイライト
            document.getElementById('restaurantName').focus();
            document.getElementById('restaurantName').style.borderColor = '#ef4444';
            setTimeout(() => {
                document.getElementById('restaurantName').style.borderColor = '';
            }, 2000);
        }

        // 距離計算（ハバーサイン公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // 地球の半径（メートル）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ログイン
        function login() {
            const companyName = document.getElementById('companyName').value.trim();
            const username = document.getElementById('username').value.trim();
            
            if (!companyName || !username) {
                alert('会社名とユーザーネームを入力してください');
                return;
            }
            
            currentUser = {
                companyName: companyName,
                username: username,
                id: Date.now().toString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainContent();
        }

        // メインコンテンツ表示
        function showMainContent() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('welcomeMessage').textContent = `${currentUser.companyName} ${currentUser.username}さん`;
            document.getElementById('companyTitle').innerHTML = `<i class="fas fa-building mr-3 text-red-600"></i>${currentUser.companyName} のおすすめ店舗`;
            
            // 地図初期化
            setTimeout(() => {
                initMap();
            }, 100);
            
            displayRestaurants();
        }

        // ログアウト
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('storeInfoSection').classList.add('hidden');
            
            // フォームリセット
            document.getElementById('companyName').value = '';
            document.getElementById('username').value = '';
            
            // 地図リセット
            if (map) {
                map.remove();
                map = null;
            }
        }

        // レストラン追加
        function addRestaurant() {
            const name = document.getElementById('restaurantName').value.trim();
            const genre = document.getElementById('genre').value;
            const area = document.getElementById('area').value.trim();
            const rating = parseInt(document.getElementById('rating').value);
            const link = document.getElementById('restaurantLink').value.trim();
            const comment = document.getElementById('comment').value.trim();
            
            if (!name) {
                alert('店舗名を入力してください');
                return;
            }
            
            if (rating === 0) {
                alert('評価を選択してください');
                return;
            }
            
            const restaurant = {
                id: Date.now().toString(),
                name: name,
                genre: genre || 'その他',
                area: area,
                rating: rating,
                link: link,
                comment: comment,
                companyName: currentUser.companyName,
                username: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            restaurants.push(restaurant);
            localStorage.setItem('restaurants', JSON.stringify(restaurants));
            
            // フォームリセット
            document.getElementById('restaurantName').value = '';
            document.getElementById('genre').value = '';
            document.getElementById('area').value = '';
            document.getElementById('restaurantLink').value = '';
            document.getElementById('comment').value = '';
            setRating(0);
            
            // 選択状態をリセット
            if (selectedStoreId) {
                const card = document.getElementById(`store-${selectedStoreId}`);
                if (card) {
                    card.classList.remove('selected');
                }
                selectedStoreId = null;
            }
            
            displayRestaurants();
            alert('店舗情報を投稿しました！');
        }

        // レストラン一覧表示
        function displayRestaurants() {
            if (!currentUser) return;
            
            const companyRestaurants = restaurants.filter(r => r.companyName === currentUser.companyName);
            const container = document.getElementById('restaurantList');
            const noResults = document.getElementById('noResults');
            
            if (companyRestaurants.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            // 評価順でソート
            companyRestaurants.sort((a, b) => b.rating - a.rating);
            
            container.innerHTML = companyRestaurants.map(restaurant => `
                <div class="restaurant-card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${restaurant.name}</h4>
                            <div class="flex items-center mb-2">
                                <span class="text-yellow-500 text-lg mr-2">${'★'.repeat(restaurant.rating)}${'☆'.repeat(5-restaurant.rating)}</span>
                                <span class="text-gray-600">${restaurant.rating}/5</span>
                            </div>
                        </div>
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">${restaurant.genre}</span>
                    </div>
                    
                    ${restaurant.area ? `<div class="flex items-center mb-3 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${restaurant.area}
                    </div>` : ''}
                    
                    ${restaurant.comment ? `<div class="mb-4">
                        <p class="text-gray-700 leading-relaxed">${restaurant.comment}</p>
                    </div>` : ''}
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-user mr-1"></i>
                            ${restaurant.username} • ${new Date(restaurant.createdAt).toLocaleDateString('ja-JP')}
                        </div>
                        
                        ${restaurant.link ? `<a href="${restaurant.link}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                            <i class="fas fa-external-link-alt mr-2"></i>店舗詳細
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // フィルター適用
        function applyFilters() {
            if (!currentUser) return;
            
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const genreFilter = document.getElementById('filterGenre').value;
            const ratingFilter = parseInt(document.getElementById('filterRating').value) || 0;
            
            let filteredRestaurants = restaurants.filter(r => r.companyName === currentUser.companyName);
            
            if (keyword) {
                filteredRestaurants = filteredRestaurants.filter(r => 
                    r.name.toLowerCase().includes(keyword) ||
                    r.comment.toLowerCase().includes(keyword) ||
                    r.area.toLowerCase().includes(keyword)
                );
            }
            
            if (genreFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.genre === genreFilter);
            }
            
            if (ratingFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.rating >= ratingFilter);
            }
            
            const container = document.getElementById('restaurantList');
            const noResults = document.getElementById('noResults');
            
            if (filteredRestaurants.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            // 評価順でソート
            filteredRestaurants.sort((a, b) => b.rating - a.rating);
            
            container.innerHTML = filteredRestaurants.map(restaurant => `
                <div class="restaurant-card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${restaurant.name}</h4>
                            <div class="flex items-center mb-2">
                                <span class="text-yellow-500 text-lg mr-2">${'★'.repeat(restaurant.rating)}${'☆'.repeat(5-restaurant.rating)}</span>
                                <span class="text-gray-600">${restaurant.rating}/5</span>
                                ${userLocation ? `<span class="distance-badge ml-2">${calculateDistanceToRestaurant(restaurant)}m</span>` : ''}
                            </div>
                        </div>
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">${restaurant.genre}</span>
                    </div>
                    
                    ${restaurant.area ? `<div class="flex items-center mb-3 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${restaurant.area}
                    </div>` : ''}
                    
                    ${restaurant.comment ? `<div class="mb-4">
                        <p class="text-gray-700 leading-relaxed">${restaurant.comment}</p>
                    </div>` : ''}
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-user mr-1"></i>
                            ${restaurant.username} • ${new Date(restaurant.createdAt).toLocaleDateString('ja-JP')}
                        </div>
                        
                        ${restaurant.link ? `<a href="${restaurant.link}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                            <i class="fas fa-external-link-alt mr-2"></i>店舗詳細
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // レストランまでの距離を計算（近似値）
        function calculateDistanceToRestaurant(restaurant) {
            if (!userLocation) return '';
            
            // サンプル店舗データから近似距離を返す
            const found = nearbyRestaurants.find(r => r.name === restaurant.name);
            return found ? found.distance : Math.floor(Math.random() * 1000) + 100;
        }
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDhE8BgjV6VS6YS2soVcmh%2BfN762u9viyxZMog4HlZ%2FvUTyqVrW%2B0cR2SaQnafotw%2F8SVgCZ%2Bwl1MsaXamFIqdecFe7KXAj1sow%2FJEcypLtJ1gMbcn%2FcG0wBY%2Bqpd%2BT7Sw9CxpN1begAD%2BdlbgmRNyvGu0rha8ysQz%2BVtOjm6ds8LD6cLHaM10hvaA3m0myKSu3NI9DOb1Pmq7CleMuqgPCpiHybTxcWzlqDjo3LokIvOGzdfs3bjb7mio597gQ%2FRG1ljWJat0SmgFOE6gIkms%2F64CCCxBzAeVFmJKLDsB2ka%2FU1MOxqkBKjAFm5YlvYheRdLRquY9TjTDrQNPkz3EfUBfvlQQ6jeuHk5ZXmTOlaqhvblHCQVZyjj5KJwmodtQjWjh7Wz48XZp247Gg%2FJN4Oi6i7one0YZ120Cr0LKJ9xopM98MW9jviFQdJCXKhRsm8FWIxvt5VhNFWux7y8DrxH%2FzjX%2BsGxxt14Cv3vUq9y8abJTnI%2Fd6ILtOHZB2mZQcuAcjBMuzXbZUdM%2BQm40os%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDhE8BgjV6VS6YS2soVcmh+fN762u9viyxZMog4HlZ/vUTyqVrW+0cR2SaQnafotw/8SVgCZ+wl1MsaXamFIqdecFe7KXAj1sow/JEcypLtJ1gMbcn/cG0wBY+qpd+T7Sw9CxpN1begAD+dlbgmRNyvGu0rha8ysQz+VtOjm6ds8LD6cLHaM10hvaA3m0myKSu3NI9DOb1Pmq7CleMuqgPCpiHybTxcWzlqDjo3LokIvOGzdfs3bjb7mio597gQ/RG1ljWJat0SmgFOE6gIkms/64CCCxBzAeVFmJKLDsB2ka/U1MOxqkBKjAFm5YlvYheRdLRquY9TjTDrQNPkz3EfUBfvlQQ6jeuHk5ZXmTOlaqhvblHCQVZyjj5KJwmodtQjWjh7Wz48XZp247Gg/JN4Oi6i7one0YZ120Cr0LKJ9xopM98MW9jviFQdJCXKhRsm8FWIxvt5VhNFWux7y8DrxH/zjX+sGxxt14Cv3vUq9y8abJTnI/d6ILtOHZB2mZQcuAcjBMuzXbZUdM+Qm40os=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    