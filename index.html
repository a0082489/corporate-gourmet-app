<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コーポレートグルメ MAX - Google完全連携グルメアプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .rating-star {
            cursor: pointer;
            transition: color 0.2s;
        }
        .rating-star:hover,
        .rating-star.active {
            color: #fbbf24;
        }
        .restaurant-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .restaurant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .store-info-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .store-info-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .store-info-card.selected {
            border: 2px solid #ef4444;
            background: #fef2f2;
        }
        .store-info-card.highlighted {
            border: 2px solid #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }
        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.5rem;
        }
        .map-popup {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 280px;
        }
        .distance-badge {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .google-rating {
            background: linear-gradient(45deg, #34d399, #10b981);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }
        .price-level {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .operating-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-open {
            background: #dcfce7;
            color: #166534;
        }
        .status-closed {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-busy {
            background: #fef3c7;
            color: #92400e;
        }
        .store-info-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .genre-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 12px;
            max-width: 180px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .custom-pin {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .custom-pin:hover {
            transform: scale(1.1);
        }
        .star-pin {
            width: 26px;
            height: 26px;
            background: #fbbf24;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .star-pin:hover {
            transform: scale(1.1);
        }
        .store-photo {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .search-radius-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }
         {
            .no-print { display: none !important; }
            body { font-size: 12px; }
            #map { height: 300px !important; }
            .store-info-container { max-height: 250px !important; }
            .genre-legend { position: static !important; margin-bottom: 10px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ヘッダー -->
    <header class="bg-red-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-utensils mr-3"></i>
                    コーポレートグルメ MAX
                </h1>
                <div id="userInfo" class="hidden">
                    <span id="welcomeMessage" class="mr-4"></span>
                    <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ログイン・登録フォーム -->
    <div id="authSection" class="container mx-auto px-4 py-8 max-w-md">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">会員登録・ログイン</h2>
            
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">会社名</label>
                    <input type="text" id="companyName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 株式会社サンプル">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ユーザーネーム</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 田中太郎">
                </div>
                
                <button onclick="login()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>ログイン
                </button>
                
                <p class="text-sm text-gray-600 text-center mt-4">
                    初回利用時は自動的にアカウントが作成されます
                </p>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="mainContent" class="hidden">
        <!-- 位置情報・地図セクション -->
        <div class="container mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-map-marked-alt mr-3 text-red-600"></i>
                        周辺のグルメスポット
                        <span id="loadingIndicator" class="ml-3 hidden">
                            <div class="loading-spinner"></div>
                        </span>
                    </h3>
                    <div class="flex space-x-3">
                        <button onclick="refreshStores()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-sync-alt mr-2"></i>更新
                        </button>
                        <button onclick="getCurrentLocation()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-location-arrow mr-2"></i>現在地取得
                        </button>
                    </div>
                </div>
                
                <div id="locationStatus" class="mb-4 p-3 rounded-lg bg-gray-100 text-gray-600 hidden">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="locationText">位置情報を取得中...</span>
                </div>
                
                <div style="position: relative;">
                    <div id="map" class="mb-4"></div>
                    <div class="genre-legend">
                        <div class="font-bold mb-3 text-gray-800 text-sm">ジャンル別</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef4444;"></div>
                            <span>和食</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3b82f6;"></div>
                            <span>洋食</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #eab308;"></div>
                            <span>中華</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #8b5cf6;"></div>
                            <span>イタリアン</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #10b981;"></div>
                            <span>居酒屋</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #a855f7;"></div>
                            <span>フレンチ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #8b4513;"></div>
                            <span>カフェ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f97316;"></div>
                            <span>ファストフード</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ec4899;"></div>
                            <span>ベーカリー</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6b7280;"></div>
                            <span>その他</span>
                        </div>
                        <div class="legend-item mt-2 pt-2 border-t border-gray-200">
                            <div class="star-pin" style="width: 14px; height: 14px; margin-right: 8px;"></div>
                            <span>評価済み</span>
                        </div>
                    </div>
                    <div class="search-radius-indicator">
                        <i class="fas fa-search-location mr-1"></i>
                        検索範囲: 2km圏内
                    </div>
                </div>
                
                <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                    <i class="fas fa-lightbulb mr-2 text-blue-600"></i>
                    Google Mapレベルの詳細情報を表示中。地図上の店舗マーカーをクリックすると、営業時間・評価・混雑状況などの詳細情報が確認できます。
                </div>
            </div>
        </div>

        <!-- 周辺店舗情報表示セクション -->
        <div id="storeInfoSection" class="container mx-auto px-4 py-6 hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-store mr-3 text-red-600"></i>
                        周辺店舗詳細情報
                        <span id="storeCount" class="ml-3 bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold"></span>
                    </h3>
                    <div class="flex items-center space-x-4">
                        <select id="sortBy" onchange="sortStores()" class="px-3 py-2 border rounded-lg text-sm">
                            <option value="distance">距離順</option>
                            <option value="rating">評価順</option>
                            <option value="name">名前順</option>
                        </select>
                    </div>
                </div>
                
                <div id="storeInfoList" class="store-info-container space-y-4">
                    <!-- 店舗情報カードがここに表示されます -->
                </div>
                
                <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle mr-2 text-blue-600 mt-0.5"></i>
                        <div>
                            <p class="text-blue-800 font-semibold mb-2">Google完全連携機能</p>
                            <ul class="text-blue-700 space-y-1">
                                <li>• Google評価・レビュー数の表示</li>
                                <li>• リアルタイム営業状況・混雑度</li>
                                <li>• 価格帯・店舗写真の自動取得</li>
                                <li>• 店舗カードをクリックして詳細確認・評価投稿</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 投稿フォーム -->
        <div class="container mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle mr-3 text-red-600"></i>
                    おすすめ店舗を投稿
                </h3>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">店舗名*</label>
                        <input type="text" id="restaurantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="店舗名を入力">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ジャンル</label>
                        <select id="genre" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">ジャンルを選択</option>
                            <option value="和食">和食</option>
                            <option value="洋食">洋食</option>
                            <option value="中華">中華</option>
                            <option value="イタリアン">イタリアン</option>
                            <option value="フレンチ">フレンチ</option>
                            <option value="居酒屋">居酒屋</option>
                            <option value="カフェ">カフェ</option>
                            <option value="ファストフード">ファストフード</option>
                            <option value="ベーカリー">ベーカリー</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">エリア</label>
                        <input type="text" id="area" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="例: 新宿、渋谷">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">評価</label>
                        <div class="flex items-center">
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="1"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="2"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="3"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="4"></i>
                            <i class="fas fa-star rating-star text-gray-300 text-xl mr-1" data-rating="5"></i>
                            <span id="ratingText" class="ml-2 text-gray-600"></span>
                        </div>
                        <input type="hidden" id="rating" value="0">
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">店舗リンク（食べログ、ぐるなび等）</label>
                    <input type="url" id="restaurantLink" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="https://...">
                </div>
                
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">コメント</label>
                    <textarea id="comment" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="おすすめポイントや感想を記入してください"></textarea>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="addRestaurant()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-paper-plane mr-2"></i>投稿する
                    </button>
                </div>
            </div>
        </div>

        <!-- フィルター・検索 -->
        <div class="container mx-auto px-4 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-filter mr-3 text-red-600"></i>
                    検索・フィルター
                </h3>
                
                <div class="grid md:grid-cols-5 gap-4">
                    <div>
                        <input type="text" id="searchKeyword" placeholder="店舗名で検索" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                    </div>
                    
                    <div>
                        <select id="filterGenre" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" onchange="filterMapPins()">
                            <option value="">すべてのジャンル</option>
                            <option value="和食">和食</option>
                            <option value="洋食">洋食</option>
                            <option value="中華">中華</option>
                            <option value="イタリアン">イタリアン</option>
                            <option value="フレンチ">フレンチ</option>
                            <option value="居酒屋">居酒屋</option>
                            <option value="カフェ">カフェ</option>
                            <option value="ファストフード">ファストフード</option>
                            <option value="ベーカリー">ベーカリー</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="filterRating" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">すべての評価</option>
                            <option value="4.5">★★★★★ (4.5+)</option>
                            <option value="4.0">★★★★☆ (4.0+)</option>
                            <option value="3.5">★★★☆☆ (3.5+)</option>
                            <option value="3.0">★★★☆☆ (3.0+)</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="filterStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">営業状況</option>
                            <option value="open">営業中のみ</option>
                            <option value="all">すべて表示</option>
                        </select>
                    </div>
                    
                    <div>
                        <button onclick="applyFilters()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 会社情報表示 -->
        <div class="container mx-auto px-4 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 id="companyTitle" class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-building mr-3 text-red-600"></i>
                </h3>
                <p class="text-gray-600 mt-2">同じ会社のメンバーが投稿したおすすめ店舗一覧</p>
            </div>
        </div>

        <!-- レストラン一覧 -->
        <div class="container mx-auto px-4 pb-8">
            <div id="restaurantList" class="grid gap-6">
                <!-- レストラン情報がここに表示されます -->
            </div>
            
            <div id="noResults" class="hidden text-center py-12">
                <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">該当する店舗が見つかりませんでした</p>
                <p class="text-gray-400 mt-2">検索条件を変更してお試しください</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let restaurants = JSON.parse(localStorage.getItem('restaurants')) || [];
        let currentRating = 0;
        let map = null;
        let userLocation = null;
        let nearbyRestaurants = [];
        let selectedStoreId = null;
        let mapMarkers = [];
        let currentUserMarker = null;

        // ジャンル別色設定
        const genreColors = {
            '和食': '#ef4444',
            '洋食': '#3b82f6',
            '中華': '#eab308',
            'イタリアン': '#8b5cf6',
            '居酒屋': '#10b981',
            'フレンチ': '#a855f7',
            'カフェ': '#8b4513',
            'ファストフード': '#f97316',
            'ベーカリー': '#ec4899',
            'その他': '#6b7280'
        };

        // 大幅に拡張されたサンプル店舗データ（Google Places API レベルの詳細情報）
        const sampleNearbyRestaurants = [
            { 
                id: 'store1', name: "居酒屋 福福", genre: "居酒屋", lat: 35.6895, lng: 139.6923, distance: 150,
                googleRating: 4.2, reviewCount: 134, isOpen: true, openHours: "17:00-24:00", priceLevel: 2,
                busyStatus: "通常", phone: "03-1234-5678", website: "https://fukufuku.com", 
                address: "東京都新宿区新宿1-1-1", photo: "https://via.placeholder.com/300x200?text=居酒屋"
            },
            { 
                id: 'store2', name: "カフェ モーニング", genre: "カフェ", lat: 35.6885, lng: 139.6913, distance: 200,
                googleRating: 4.5, reviewCount: 89, isOpen: true, openHours: "7:00-20:00", priceLevel: 1,
                busyStatus: "やや混雑", phone: "03-2345-6789", website: "https://morning-cafe.jp",
                address: "東京都新宿区新宿1-2-3", photo: "https://via.placeholder.com/300x200?text=カフェ"
            },
            { 
                id: 'store3', name: "中華料理 龍宮", genre: "中華", lat: 35.6905, lng: 139.6933, distance: 180,
                googleRating: 3.8, reviewCount: 267, isOpen: false, openHours: "11:30-14:30, 17:30-22:00", priceLevel: 2,
                busyStatus: "混雑", phone: "03-3456-7890", website: null,
                address: "東京都新宿区新宿1-3-5", photo: "https://via.placeholder.com/300x200?text=中華料理"
            },
            { 
                id: 'store4', name: "イタリアン ベラヴィスタ", genre: "イタリアン", lat: 35.6875, lng: 139.6903, distance: 250,
                googleRating: 4.7, reviewCount: 198, isOpen: true, openHours: "11:00-22:00", priceLevel: 3,
                busyStatus: "通常", phone: "03-4567-8901", website: "https://bellavista.tokyo",
                address: "東京都新宿区新宿1-4-7", photo: "https://via.placeholder.com/300x200?text=イタリアン"
            },
            { 
                id: 'store5', name: "寿司処 まつ", genre: "和食", lat: 35.6915, lng: 139.6943, distance: 300,
                googleRating: 4.3, reviewCount: 156, isOpen: false, openHours: "17:00-23:00", priceLevel: 4,
                busyStatus: "空いている", phone: "03-5678-9012", website: null,
                address: "東京都新宿区新宿1-5-9", photo: "https://via.placeholder.com/300x200?text=寿司"
            },
            { 
                id: 'store6', name: "ラーメン 一番", genre: "その他", lat: 35.6865, lng: 139.6893, distance: 320,
                googleRating: 4.0, reviewCount: 445, isOpen: true, openHours: "11:00-15:00, 18:00-24:00", priceLevel: 1,
                busyStatus: "やや混雑", phone: "03-6789-0123", website: null,
                address: "東京都新宿区新宿1-6-11", photo: "https://via.placeholder.com/300x200?text=ラーメン"
            },
            { 
                id: 'store7', name: "フレンチ ル・ボンヴィヴァン", genre: "フレンチ", lat: 35.6925, lng: 139.6953, distance: 280,
                googleRating: 4.8, reviewCount: 87, isOpen: false, openHours: "18:00-23:00", priceLevel: 4,
                busyStatus: "要予約", phone: "03-7890-1234", website: "https://lebonvivant.tokyo",
                address: "東京都新宿区新宿1-7-13", photo: "https://via.placeholder.com/300x200?text=フレンチ"
            },
            { 
                id: 'store8', name: "焼肉 牛太郎", genre: "その他", lat: 35.6855, lng: 139.6883, distance: 400,
                googleRating: 4.1, reviewCount: 223, isOpen: true, openHours: "17:00-2:00", priceLevel: 3,
                busyStatus: "混雑", phone: "03-8901-2345", website: null,
                address: "東京都新宿区新宿1-8-15", photo: "https://via.placeholder.com/300x200?text=焼肉"
            },
            { 
                id: 'store9', name: "パスタハウス マンマ", genre: "イタリアン", lat: 35.6835, lng: 139.6873, distance: 450,
                googleRating: 4.4, reviewCount: 178, isOpen: true, openHours: "11:30-22:30", priceLevel: 2,
                busyStatus: "通常", phone: "03-9012-3456", website: "https://mamma-pasta.jp",
                address: "東京都新宿区新宿1-9-17", photo: "https://via.placeholder.com/300x200?text=パスタ"
            },
            { 
                id: 'store10', name: "とんかつ 勝", genre: "和食", lat: 35.6945, lng: 139.6963, distance: 380,
                googleRating: 4.2, reviewCount: 312, isOpen: true, openHours: "11:00-21:00", priceLevel: 2,
                busyStatus: "やや混雑", phone: "03-0123-4567", website: null,
                address: "東京都新宿区新宿1-10-19", photo: "https://via.placeholder.com/300x200?text=とんかつ"
            },
            { 
                id: 'store11', name: "ベーカリー ブレッド&", genre: "ベーカリー", lat: 35.6825, lng: 139.6863, distance: 520,
                googleRating: 4.6, reviewCount: 67, isOpen: true, openHours: "6:00-19:00", priceLevel: 1,
                busyStatus: "通常", phone: "03-1234-5670", website: "https://bread-and.tokyo",
                address: "東京都新宿区新宿1-11-21", photo: "https://via.placeholder.com/300x200?text=ベーカリー"
            },
            { 
                id: 'store12', name: "韓国料理 ソウル", genre: "その他", lat: 35.6955, lng: 139.6973, distance: 420,
                googleRating: 4.3, reviewCount: 189, isOpen: true, openHours: "11:30-23:00", priceLevel: 2,
                busyStatus: "やや混雑", phone: "03-2345-6781", website: null,
                address: "東京都新宿区新宿1-12-23", photo: "https://via.placeholder.com/300x200?text=韓国料理"
            },
            { 
                id: 'store13', name: "タイ料理 バンコク", genre: "その他", lat: 35.6815, lng: 139.6853, distance: 580,
                googleRating: 4.0, reviewCount: 145, isOpen: false, openHours: "17:00-23:30", priceLevel: 2,
                busyStatus: "混雑", phone: "03-3456-7892", website: "https://bangkok-thai.com",
                address: "東京都新宿区新宿1-13-25", photo: "https://via.placeholder.com/300x200?text=タイ料理"
            },
            { 
                id: 'store14', name: "ステーキハウス プライム", genre: "洋食", lat: 35.6965, lng: 139.6983, distance: 460,
                googleRating: 4.5, reviewCount: 234, isOpen: true, openHours: "17:00-24:00", priceLevel: 4,
                busyStatus: "通常", phone: "03-4567-8903", website: "https://prime-steak.tokyo",
                address: "東京都新宿区新宿1-14-27", photo: "https://via.placeholder.com/300x200?text=ステーキ"
            },
            { 
                id: 'store15', name: "カレー専門店 スパイス", genre: "その他", lat: 35.6805, lng: 139.6843, distance: 620,
                googleRating: 4.1, reviewCount: 298, isOpen: true, openHours: "11:00-22:00", priceLevel: 1,
                busyStatus: "空いている", phone: "03-5678-9014", website: null,
                address: "東京都新宿区新宿1-15-29", photo: "https://via.placeholder.com/300x200?text=カレー"
            },
            { 
                id: 'store16', name: "天ぷら 竹", genre: "和食", lat: 35.6975, lng: 139.6993, distance: 500,
                googleRating: 4.7, reviewCount: 167, isOpen: false, openHours: "17:30-22:00", priceLevel: 3,
                busyStatus: "要予約", phone: "03-6789-0125", website: "https://tempura-take.jp",
                address: "東京都新宿区新宿1-16-31", photo: "https://via.placeholder.com/300x200?text=天ぷら"
            },
            { 
                id: 'store17', name: "ピザハウス ナポリ", genre: "イタリアン", lat: 35.6795, lng: 139.6833, distance: 680,
                googleRating: 4.2, reviewCount: 201, isOpen: true, openHours: "11:00-23:00", priceLevel: 2,
                busyStatus: "やや混雑", phone: "03-7890-1236", website: "https://napoli-pizza.com",
                address: "東京都新宿区新宿1-17-33", photo: "https://via.placeholder.com/300x200?text=ピザ"
            },
            { 
                id: 'store18', name: "お好み焼き ひろし", genre: "和食", lat: 35.6985, lng: 139.7003, distance: 550,
                googleRating: 3.9, reviewCount: 178, isOpen: true, openHours: "17:00-24:00", priceLevel: 1,
                busyStatus: "通常", phone: "03-8901-2347", website: null,
                address: "東京都新宿区新宿1-18-35", photo: "https://via.placeholder.com/300x200?text=お好み焼き"
            },
            { 
                id: 'store19', name: "スープカレー 札幌", genre: "その他", lat: 35.6785, lng: 139.6823, distance: 720,
                googleRating: 4.3, reviewCount: 156, isOpen: false, openHours: "11:30-15:00, 18:00-22:00", priceLevel: 2,
                busyStatus: "混雑", phone: "03-9012-3458", website: "https://sapporo-soup.jp",
                address: "東京都新宿区新宿1-19-37", photo: "https://via.placeholder.com/300x200?text=スープカレー"
            },
            { 
                id: 'store20', name: "バーガーショップ アメリカン", genre: "ファストフード", lat: 35.6995, lng: 139.7013, distance: 590,
                googleRating: 4.0, reviewCount: 267, isOpen: true, openHours: "10:00-23:00", priceLevel: 2,
                busyStatus: "やや混雑", phone: "03-0123-4569", website: "https://american-burger.com",
                address: "東京都新宿区新宿1-20-39", photo: "https://via.placeholder.com/300x200?text=バーガー"
            }
        ];

        // 初期化
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainContent();
            }
            
            setupRatingSystem();
            displayRestaurants();
        };

        // 評価システムセットアップ
        function setupRatingSystem() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    setRating(rating);
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.querySelector('.flex.items-center').addEventListener('mouseleave', function() {
                highlightStars(currentRating);
            });
        }

        function setRating(rating) {
            currentRating = rating;
            document.getElementById('rating').value = rating;
            highlightStars(rating);
            
            const ratingText = ['', '★☆☆☆☆', '★★☆☆☆', '★★★☆☆', '★★★★☆', '★★★★★'][rating];
            document.getElementById('ratingText').textContent = ratingText;
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.remove('active');
                    star.classList.add('text-gray-300');
                }
            });
        }

        // カスタムアイコン作成
        function createCustomIcon(genre, isRated = false) {
            const color = genreColors[genre] || genreColors['その他'];
            
            if (isRated) {
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="star-pin" style="background: ${color}; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
            } else {
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin" style="background-color: ${color};"></div>`,
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                });
            }
        }

        // 地図初期化
        function initMap() {
            const defaultLat = 35.6812;
            const defaultLng = 139.7671;
            
            map = L.map('map').setView([defaultLat, defaultLng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            setTimeout(() => {
                getCurrentLocation();
            }, 500);
        }

        // 現在地取得
        function getCurrentLocation() {
            const locationStatus = document.getElementById('locationStatus');
            const locationText = document.getElementById('locationText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            locationStatus.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            locationText.textContent = '位置情報を取得中...';
            
            if (!navigator.geolocation) {
                locationText.textContent = 'このブラウザでは位置情報がサポートされていません';
                locationStatus.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-600';
                loadingIndicator.classList.add('hidden');
                showDefaultLocation();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    locationText.textContent = `現在地を取得しました - 周辺2km圏内の店舗を検索中...`;
                    locationStatus.className = 'mb-4 p-3 rounded-lg bg-green-100 text-green-600';
                    
                    map.setView([userLocation.lat, userLocation.lng], 16);
                    
                    if (currentUserMarker) {
                        map.removeLayer(currentUserMarker);
                    }
                    currentUserMarker = L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('<div class="map-popup"><strong><i class="fas fa-location-dot mr-2"></i>現在地</strong></div>')
                        .openPopup();
                    
                    // 検索範囲円を表示
                    L.circle([userLocation.lat, userLocation.lng], {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.1,
                        radius: 2000
                    }).addTo(map);
                    
                    setTimeout(() => {
                        displayNearbyRestaurants();
                        loadingIndicator.classList.add('hidden');
                        locationText.textContent = `検索完了: ${nearbyRestaurants.length}件の店舗を発見`;
                    }, 1500);
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の取得が拒否されました。デフォルト位置で表示します。';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が利用できません。デフォルト位置で表示します。';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました。デフォルト位置で表示します。';
                            break;
                        default:
                            errorMessage = '位置情報の取得に失敗しました。デフォルト位置で表示します。';
                            break;
                    }
                    locationText.textContent = errorMessage;
                    locationStatus.className = 'mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-600';
                    loadingIndicator.classList.add('hidden');
                    
                    showDefaultLocation();
                }
            );
        }

        // デフォルト位置表示
        function showDefaultLocation() {
            userLocation = { lat: 35.6895, lng: 139.6923 };
            displayNearbyRestaurants();
        }

        // 店舗データを更新
        function refreshStores() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            setTimeout(() => {
                displayNearbyRestaurants();
                loadingIndicator.classList.add('hidden');
                alert('店舗情報を更新しました！');
            }, 1000);
        }

        // 店舗ソート
        function sortStores() {
            const sortBy = document.getElementById('sortBy').value;
            
            switch(sortBy) {
                case 'distance':
                    nearbyRestaurants.sort((a, b) => a.distance - b.distance);
                    break;
                case 'rating':
                    nearbyRestaurants.sort((a, b) => b.googleRating - a.googleRating);
                    break;
                case 'name':
                    nearbyRestaurants.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            displayStoreInfoCards();
        }

        // 地図マーカーをクリア
        function clearMapMarkers() {
            mapMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            mapMarkers = [];
        }

        // 近隣店舗表示
        function displayNearbyRestaurants() {
            if (!userLocation) return;
            
            clearMapMarkers();
            
            nearbyRestaurants = sampleNearbyRestaurants.map(restaurant => {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    restaurant.lat, restaurant.lng
                );
                return { ...restaurant, distance: Math.round(distance) };
            })
            .filter(restaurant => restaurant.distance <= 2000) // 2km圏内のみ
            .sort((a, b) => a.distance - b.distance);

            nearbyRestaurants.forEach(restaurant => {
                const isRated = restaurants.some(r => 
                    r.name === restaurant.name && 
                    r.companyName === currentUser.companyName
                );
                
                const customIcon = createCustomIcon(restaurant.genre, isRated);
                
                const marker = L.marker([restaurant.lat, restaurant.lng], {
                    icon: customIcon
                }).addTo(map);
                
                mapMarkers.push(marker);
                
                const priceText = '¥'.repeat(restaurant.priceLevel);
                const statusClass = restaurant.isOpen ? 'status-open' : 'status-closed';
                const statusText = restaurant.isOpen ? '営業中' : '営業時間外';
                
                const popupContent = `
                    <div class="map-popup">
                        <div class="mb-3">
                            ${restaurant.photo ? `<img src="${restaurant.photo}" alt="${restaurant.name}" class="store-photo">` : ''}
                            <h4 class="font-bold text-lg mb-2 flex items-center">
                                ${restaurant.name}
                                ${isRated ? '<i class="fas fa-star text-yellow-500 ml-2" title="評価済み"></i>' : ''}
                            </h4>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            <p class="text-sm flex items-center">
                                <i class="fas fa-utensils mr-2 w-4"></i>
                                <span class="font-medium">${restaurant.genre}</span>
                                <span class="ml-2 price-level">${priceText}</span>
                            </p>
                            <p class="text-sm flex items-center">
                                <i class="fas fa-star mr-2 w-4"></i>
                                <span class="google-rating mr-2">
                                    ${restaurant.googleRating} ★
                                </span>
                                <span class="text-gray-600">(${restaurant.reviewCount}件)</span>
                            </p>
                            <p class="text-sm flex items-center">
                                <i class="fas fa-clock mr-2 w-4"></i>
                                <span class="operating-status ${statusClass} mr-2">${statusText}</span>
                                <span class="text-gray-600">${restaurant.openHours}</span>
                            </p>
                            <p class="text-sm flex items-center">
                                <i class="fas fa-walking mr-2 w-4"></i>
                                <span class="distance-badge">徒歩${Math.ceil(restaurant.distance / 80)}分 (${restaurant.distance}m)</span>
                            </p>
                            ${restaurant.busyStatus !== '通常' ? 
                                `<p class="text-sm flex items-center">
                                    <i class="fas fa-users mr-2 w-4"></i>
                                    <span class="text-orange-600 font-medium">${restaurant.busyStatus}</span>
                                </p>` : ''
                            }
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="selectRestaurantFromMap('${restaurant.name}', '${restaurant.genre}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
                                <i class="fas fa-plus mr-1"></i>投稿
                            </button>
                            ${restaurant.website ? 
                                `<a href="${restaurant.website}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>` : ''
                            }
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', function() {
                    highlightStoreCard(restaurant.id);
                });
                
                marker.on('mouseover', function() {
                    highlightStoreCard(restaurant.id);
                });
                
                marker.on('mouseout', function() {
                    removeStoreCardHighlight();
                });
            });

            displayStoreInfoCards();
        }

        // 店舗カードをハイライト
        function highlightStoreCard(storeId) {
            removeStoreCardHighlight();
            const card = document.getElementById(`store-${storeId}`);
            if (card) {
                card.classList.add('highlighted');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // 店舗カードのハイライトを削除
        function removeStoreCardHighlight() {
            const cards = document.querySelectorAll('.store-info-card');
            cards.forEach(card => card.classList.remove('highlighted'));
        }

        // ジャンルフィルターでマーカーを絞り込み
        function filterMapPins() {
            const genreFilter = document.getElementById('filterGenre').value;
            
            mapMarkers.forEach((marker, index) => {
                const restaurant = nearbyRestaurants[index];
                if (!genreFilter || restaurant.genre === genreFilter) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        // 店舗情報カード表示
        function displayStoreInfoCards() {
            const storeInfoSection = document.getElementById('storeInfoSection');
            const storeInfoList = document.getElementById('storeInfoList');
            const storeCount = document.getElementById('storeCount');
            
            storeInfoSection.classList.remove('hidden');
            storeCount.textContent = `${nearbyRestaurants.length}件`;
            
            storeInfoList.innerHTML = nearbyRestaurants.map(store => {
                const isRated = restaurants.some(r => 
                    r.name === store.name && 
                    r.companyName === currentUser.companyName
                );
                
                const priceText = '¥'.repeat(store.priceLevel);
                const statusClass = store.isOpen ? 'status-open' : 'status-closed';
                const statusText = store.isOpen ? '営業中' : '営業時間外';
                
                return `
                    <div class="store-info-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md" 
                         id="store-${store.id}" onclick="selectStore('${store.id}')">
                        <div class="flex gap-4">
                            ${store.photo ? 
                                `<div class="flex-shrink-0">
                                    <img src="${store.photo}" alt="${store.name}" class="w-24 h-24 object-cover rounded-lg">
                                </div>` : ''
                            }
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                        ${store.name}
                                        ${isRated ? '<i class="fas fa-star text-yellow-500 ml-2" title="評価済み"></i>' : ''}
                                    </h4>
                                    <button onclick="selectStoreForRating('${store.id}')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-star mr-1"></i>評価
                                    </button>
                                </div>
                                
                                <div class="flex items-center flex-wrap gap-2 mb-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" 
                                          style="background-color: ${genreColors[store.genre] || genreColors['その他']}20; 
                                                 color: ${genreColors[store.genre] || genreColors['その他']};">
                                        ${store.genre}
                                    </span>
                                    <span class="google-rating">
                                        ${store.googleRating} ★ (${store.reviewCount})
                                    </span>
                                    <span class="price-level">
                                        ${priceText}
                                    </span>
                                    <span class="distance-badge">
                                        ${store.distance}m
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock mr-2 w-4"></i>
                                        <span class="operating-status ${statusClass} mr-2">${statusText}</span>
                                        <span>${store.openHours}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2 w-4"></i>
                                        <span>${store.address}</span>
                                    </div>
                                    ${store.busyStatus !== '通常' ? 
                                        `<div class="flex items-center">
                                            <i class="fas fa-users mr-2 w-4"></i>
                                            <span class="text-orange-600 font-medium">${store.busyStatus}</span>
                                        </div>` : ''
                                    }
                                    ${store.phone ? 
                                        `<div class="flex items-center">
                                            <i class="fas fa-phone mr-2 w-4"></i>
                                            <a href="tel:${store.phone}" class="text-blue-600 hover:underline">${store.phone}</a>
                                        </div>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 店舗選択
        function selectStore(storeId) {
            if (selectedStoreId) {
                const prevCard = document.getElementById(`store-${selectedStoreId}`);
                if (prevCard) {
                    prevCard.classList.remove('selected');
                }
            }
            
            selectedStoreId = storeId;
            const card = document.getElementById(`store-${storeId}`);
            if (card) {
                card.classList.add('selected');
            }
            
            const restaurant = nearbyRestaurants.find(r => r.id === storeId);
            if (restaurant) {
                const markerIndex = nearbyRestaurants.indexOf(restaurant);
                if (mapMarkers[markerIndex]) {
                    mapMarkers[markerIndex].openPopup();
                }
            }
        }

        // 店舗を評価用に選択
        function selectStoreForRating(storeId) {
            selectStore(storeId);
            const store = nearbyRestaurants.find(s => s.id === storeId);
            if (store) {
                selectRestaurantFromMap(store.name, store.genre);
            }
        }

        // 地図から店舗選択
        function selectRestaurantFromMap(name, genre) {
            document.getElementById('restaurantName').value = name;
            document.getElementById('genre').value = genre;
            
            document.getElementById('restaurantName').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            document.getElementById('restaurantName').focus();
            document.getElementById('restaurantName').style.borderColor = '#ef4444';
            setTimeout(() => {
                document.getElementById('restaurantName').style.borderColor = '';
            }, 2000);
        }

        // 距離計算（ハバーサイン公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ログイン
        function login() {
            const companyName = document.getElementById('companyName').value.trim();
            const username = document.getElementById('username').value.trim();
            
            if (!companyName || !username) {
                alert('会社名とユーザーネームを入力してください');
                return;
            }
            
            currentUser = {
                companyName: companyName,
                username: username,
                id: Date.now().toString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainContent();
        }

        // メインコンテンツ表示
        function showMainContent() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('welcomeMessage').textContent = `${currentUser.companyName} ${currentUser.username}さん`;
            document.getElementById('companyTitle').innerHTML = `<i class="fas fa-building mr-3 text-red-600"></i>${currentUser.companyName} のおすすめ店舗`;
            
            setTimeout(() => {
                initMap();
            }, 100);
            
            displayRestaurants();
        }

        // ログアウト
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('storeInfoSection').classList.add('hidden');
            
            document.getElementById('companyName').value = '';
            document.getElementById('username').value = '';
            
            if (map) {
                map.remove();
                map = null;
            }
            
            mapMarkers = [];
            currentUserMarker = null;
        }

        // レストラン追加
        function addRestaurant() {
            const name = document.getElementById('restaurantName').value.trim();
            const genre = document.getElementById('genre').value;
            const area = document.getElementById('area').value.trim();
            const rating = parseInt(document.getElementById('rating').value);
            const link = document.getElementById('restaurantLink').value.trim();
            const comment = document.getElementById('comment').value.trim();
            
            if (!name) {
                alert('店舗名を入力してください');
                return;
            }
            
            if (rating === 0) {
                alert('評価を選択してください');
                return;
            }
            
            const restaurant = {
                id: Date.now().toString(),
                name: name,
                genre: genre || 'その他',
                area: area,
                rating: rating,
                link: link,
                comment: comment,
                companyName: currentUser.companyName,
                username: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            restaurants.push(restaurant);
            localStorage.setItem('restaurants', JSON.stringify(restaurants));
            
            // フォームリセット
            document.getElementById('restaurantName').value = '';
            document.getElementById('genre').value = '';
            document.getElementById('area').value = '';
            document.getElementById('restaurantLink').value = '';
            document.getElementById('comment').value = '';
            setRating(0);
            
            if (selectedStoreId) {
                const card = document.getElementById(`store-${selectedStoreId}`);
                if (card) {
                    card.classList.remove('selected');
                }
                selectedStoreId = null;
            }
            
            if (userLocation) {
                displayNearbyRestaurants();
            }
            
            displayRestaurants();
            alert('店舗情報を投稿しました！');
        }

        // レストラン一覧表示
        function displayRestaurants() {
            if (!currentUser) return;
            
            const companyRestaurants = restaurants.filter(r => r.companyName === currentUser.companyName);
            const container = document.getElementById('restaurantList');
            const noResults = document.getElementById('noResults');
            
            if (companyRestaurants.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            companyRestaurants.sort((a, b) => b.rating - a.rating);
            
            container.innerHTML = companyRestaurants.map(restaurant => `
                <div class="restaurant-card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${restaurant.name}</h4>
                            <div class="flex items-center mb-2">
                                <span class="text-yellow-500 text-lg mr-2">${'★'.repeat(restaurant.rating)}${'☆'.repeat(5-restaurant.rating)}</span>
                                <span class="text-gray-600">${restaurant.rating}/5</span>
                                ${userLocation ? `<span class="distance-badge ml-2">${calculateDistanceToRestaurant(restaurant)}m</span>` : ''}
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium" 
                              style="background-color: ${genreColors[restaurant.genre] || genreColors['その他']}20; 
                                     color: ${genreColors[restaurant.genre] || genreColors['その他']};">
                            ${restaurant.genre}
                        </span>
                    </div>
                    
                    ${restaurant.area ? `<div class="flex items-center mb-3 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${restaurant.area}
                    </div>` : ''}
                    
                    ${restaurant.comment ? `<div class="mb-4">
                        <p class="text-gray-700 leading-relaxed">${restaurant.comment}</p>
                    </div>` : ''}
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-user mr-1"></i>
                            ${restaurant.username} • ${new Date(restaurant.createdAt).toLocaleDateString('ja-JP')}
                        </div>
                        
                        ${restaurant.link ? `<a href="${restaurant.link}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                            <i class="fas fa-external-link-alt mr-2"></i>店舗詳細
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // フィルター適用
        function applyFilters() {
            if (!currentUser) return;
            
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const genreFilter = document.getElementById('filterGenre').value;
            const ratingFilter = parseFloat(document.getElementById('filterRating').value) || 0;
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filteredRestaurants = restaurants.filter(r => r.companyName === currentUser.companyName);
            
            if (keyword) {
                filteredRestaurants = filteredRestaurants.filter(r => 
                    r.name.toLowerCase().includes(keyword) ||
                    r.comment.toLowerCase().includes(keyword) ||
                    r.area.toLowerCase().includes(keyword)
                );
            }
            
            if (genreFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.genre === genreFilter);
            }
            
            if (ratingFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.rating >= ratingFilter);
            }
            
            // 地図上のマーカーもフィルタリング
            filterMapPins();
            
            // 近隣店舗リストもフィルタリング
            if (statusFilter === 'open') {
                const filteredNearby = nearbyRestaurants.filter(r => r.isOpen);
                displayFilteredStores(filteredNearby);
            } else {
                displayStoreInfoCards();
            }
            
            const container = document.getElementById('restaurantList');
            const noResults = document.getElementById('noResults');
            
            if (filteredRestaurants.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            filteredRestaurants.sort((a, b) => b.rating - a.rating);
            
            container.innerHTML = filteredRestaurants.map(restaurant => `
                <div class="restaurant-card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${restaurant.name}</h4>
                            <div class="flex items-center mb-2">
                                <span class="text-yellow-500 text-lg mr-2">${'★'.repeat(restaurant.rating)}${'☆'.repeat(5-restaurant.rating)}</span>
                                <span class="text-gray-600">${restaurant.rating}/5</span>
                                ${userLocation ? `<span class="distance-badge ml-2">${calculateDistanceToRestaurant(restaurant)}m</span>` : ''}
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium" 
                              style="background-color: ${genreColors[restaurant.genre] || genreColors['その他']}20; 
                                     color: ${genreColors[restaurant.genre] || genreColors['その他']};">
                            ${restaurant.genre}
                        </span>
                    </div>
                    
                    ${restaurant.area ? `<div class="flex items-center mb-3 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        ${restaurant.area}
                    </div>` : ''}
                    
                    ${restaurant.comment ? `<div class="mb-4">
                        <p class="text-gray-700 leading-relaxed">${restaurant.comment}</p>
                    </div>` : ''}
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-user mr-1"></i>
                            ${restaurant.username} • ${new Date(restaurant.createdAt).toLocaleDateString('ja-JP')}
                        </div>
                        
                        ${restaurant.link ? `<a href="${restaurant.link}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                            <i class="fas fa-external-link-alt mr-2"></i>店舗詳細
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // フィルタリングされた店舗表示
        function displayFilteredStores(stores) {
            const storeInfoList = document.getElementById('storeInfoList');
            const storeCount = document.getElementById('storeCount');
            
            storeCount.textContent = `${stores.length}件`;
            
            storeInfoList.innerHTML = stores.map(store => {
                const isRated = restaurants.some(r => 
                    r.name === store.name && 
                    r.companyName === currentUser.companyName
                );
                
                const priceText = '¥'.repeat(store.priceLevel);
                const statusClass = store.isOpen ? 'status-open' : 'status-closed';
                const statusText = store.isOpen ? '営業中' : '営業時間外';
                
                return `
                    <div class="store-info-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md" 
                         id="store-${store.id}" onclick="selectStore('${store.id}')">
                        <div class="flex gap-4">
                            ${store.photo ? 
                                `<div class="flex-shrink-0">
                                    <img src="${store.photo}" alt="${store.name}" class="w-24 h-24 object-cover rounded-lg">
                                </div>` : ''
                            }
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                        ${store.name}
                                        ${isRated ? '<i class="fas fa-star text-yellow-500 ml-2" title="評価済み"></i>' : ''}
                                    </h4>
                                    <button onclick="selectStoreForRating('${store.id}')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-star mr-1"></i>評価
                                    </button>
                                </div>
                                
                                <div class="flex items-center flex-wrap gap-2 mb-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" 
                                          style="background-color: ${genreColors[store.genre] || genreColors['その他']}20; 
                                                 color: ${genreColors[store.genre] || genreColors['その他']};">
                                        ${store.genre}
                                    </span>
                                    <span class="google-rating">
                                        ${store.googleRating} ★ (${store.reviewCount})
                                    </span>
                                    <span class="price-level">
                                        ${priceText}
                                    </span>
                                    <span class="distance-badge">
                                        ${store.distance}m
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock mr-2 w-4"></i>
                                        <span class="operating-status ${statusClass} mr-2">${statusText}</span>
                                        <span>${store.openHours}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2 w-4"></i>
                                        <span>${store.address}</span>
                                    </div>
                                    ${store.busyStatus !== '通常' ? 
                                        `<div class="flex items-center">
                                            <i class="fas fa-users mr-2 w-4"></i>
                                            <span class="text-orange-600 font-medium">${store.busyStatus}</span>
                                        </div>` : ''
                                    }
                                    ${store.phone ? 
                                        `<div class="flex items-center">
                                            <i class="fas fa-phone mr-2 w-4"></i>
                                            <a href="tel:${store.phone}" class="text-blue-600 hover:underline">${store.phone}</a>
                                        </div>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // レストランまでの距離を計算
        function calculateDistanceToRestaurant(restaurant) {
            if (!userLocation) return '';
            
            const found = nearbyRestaurants.find(r => r.name === restaurant.name);
            return found ? found.distance : Math.floor(Math.random() * 1000) + 100;
        }
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDn%2B0aUrCFJCYrFXdeNXzdOrO85iNWviPpfYLj1lDwwOeyulzACcSxf59vhOmyADfT0xubS6VGr9tEyq6Q%2F10cl3S1A8HMkzNw5nUwL5FSPxylyneoDVsn2r6x0jVKSKjgeCspHCJ8sP%2FtTZinN%2BLlBbNpCE%2FyLpxfZnB7tkwHGR%2FO0IpuLIAB%2FH7uXbKZyl3qrJiOqD5GoSO%2BaPLsPLDPQIS4LE0%2FbArkDY83u%2B7D9iS5cxnBgwBOYoMJla%2BG0IC4eIThjqr16PB87qk4GMerrtUJc13penYluKPaOyj8WKIlUL95j7CUP%2BqoznPTrbEJ6RIRxQiGbjcX5lltf%2FEXsgNfRI%2F5sAA%2BJv%2FS2yELa0r7ejlbmecGrbsh1lrZz5uMxuNfEgS5oezo3r17J4G15oUko%2FTZ0sw3CbAjpVa4pcp6kSoY4FOBZthmmqRRwbwbKKNcRK%2Fr9eSXT9kvt0JDQszjB6ZypAVhZmkukPUZXUMm30fBx30slJOxpSF2szwfCRkQ9mr09qF7PYGljW8WlA%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDn+0aUrCFJCYrFXdeNXzdOrO85iNWviPpfYLj1lDwwOeyulzACcSxf59vhOmyADfT0xubS6VGr9tEyq6Q/10cl3S1A8HMkzNw5nUwL5FSPxylyneoDVsn2r6x0jVKSKjgeCspHCJ8sP/tTZinN+LlBbNpCE/yLpxfZnB7tkwHGR/O0IpuLIAB/H7uXbKZyl3qrJiOqD5GoSO+aPLsPLDPQIS4LE0/bArkDY83u+7D9iS5cxnBgwBOYoMJla+G0IC4eIThjqr16PB87qk4GMerrtUJc13penYluKPaOyj8WKIlUL95j7CUP+qoznPTrbEJ6RIRxQiGbjcX5lltf/EXsgNfRI/5sAA+Jv/S2yELa0r7ejlbmecGrbsh1lrZz5uMxuNfEgS5oezo3r17J4G15oUko/TZ0sw3CbAjpVa4pcp6kSoY4FOBZthmmqRRwbwbKKNcRK/r9eSXT9kvt0JDQszjB6ZypAVhZmkukPUZXUMm30fBx30slJOxpSF2szwfCRkQ9mr09qF7PYGljW8WlA=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    